$schema: https://componentsdk.azureedge.net/jsonschema/DistributedComponent.json
# $schema: http://azureml/sdk-2-0/CommandComponent.json
description: "RLHF Single Evaluation"
display_name: RLHF Single Evaluation
environment:
  docker: 
    # image: b5476ead59e14b909c1c0afdc3422078.azurecr.io/megatron-deepspeed-moe
    # image: babeleusrefere459829475348.azurecr.io/megatron-deepspeed-moe

    # image: mcr.microsoft.com/azureml/openmpi3.1.2-cuda10.2-cudnn8-ubuntu18.04
  #   image: mcr.microsoft.com/azureml/curated/acpt-pytorch-1.11-py38-cuda11.5-gpu


    # image: mcr.microsoft.com/azureml/curated/acpt-pytorch-1.13-py38-cuda11.7-gpu
    image: pytorch/pytorch:2.0.1-cuda11.7-cudnn8-devel
  conda:
    conda_dependencies:
      name: project_environment
      channels:
      - defaults
      dependencies:
      - python=3.8.13
      - pip:
        - einops
        - opt-einsum
        - datasets>=2.8.0
        - sentencepiece>=0.1.97
        - protobuf==3.20.3
        - accelerate>=0.15.0
        - torch>=1.12.0
        - deepspeed>=0.9.2
        - transformers>=4.29.0
        - pandas
        - azureml-core
        - rouge-score
        # - git+https://github.com/huggingface/transformers

  os: Linux
inputs: 
  data_path: 
    description: data_path
    optional: true
    type: path
  model_name_baseline: 
    description: Model name for baseline
    optional: true
    default: ""
    type: string
  model_path_baseline: 
    description: Model path for baseline
    optional: true
    default: ""
    type: path
  baseline_combined_mode: 
    description: Use combined actor/critic for baseline
    optional: true
    default: "not_combined"
    type: string
  num_padding_at_beginning: 
    description: num_padding_at_beginning
    optional: false
    default: 1
    type: int
  max_new_tokens:
    description: max_new_tokens
    optional: true
    default: 256
    type: int





is_deterministic: true
meta: 
  requireGpu: true
name: ds_rlhf.eval
outputs: 
  output_dir: 
    description: Output directory
    optional: false
    type: path

code: ../../../

launcher:
  type: torch.distributed
  additional_arguments: >    
    pip install -e .[['all']] && python ./examples/training/step4_eval/solo_prompt_eval.py
      [--data_path {inputs.data_path}]
      [--model_name_baseline {inputs.model_name_baseline} ]
      [--model_path_baseline {inputs.model_path_baseline} ]
      --num_padding_at_beginning {inputs.num_padding_at_beginning}
      [--baseline_combined_mode {inputs.baseline_combined_mode}]
      [--max_new_tokens {inputs.max_new_tokens}]
      --output_dir {outputs.output_dir}


tags: 
  author: misantac@microsoft.com
type: DistributedComponent
version: 0.1.0